<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dry White Season Checklist (Shared)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Permanent Marker', cursive;
            background-color: #f0f0f0;
            background-image:
                linear-gradient(to right, rgba(0,0,0,0.1) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0,0,0,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding-top: 20px;
            padding-bottom: 40px;
            color: #333;
        }
        .checklist-container {
            background-color: white;
            padding: 30px 40px;
            border-radius: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 700px;
        }
        h1 {
            font-size: 2.8em; text-align: center; margin-top: 0; margin-bottom: 5px; color: #222; line-height: 1;
        }
        .subtitle {
            text-align: right; font-size: 1.1em; margin-top: -15px; margin-bottom: 10px; margin-right: 20px; color: #444; font-style: italic;
        }
        hr.title-line {
            border: 0; height: 2px; background-color: #333; margin-bottom: 20px;
        }
        table {
            width: 100%; border-collapse: collapse; margin-top: 10px;
        }
        th, td {
            padding: 12px 8px; text-align: center; font-size: 1.1em; vertical-align: middle;
        }
        th.col-pampas-cat { min-width: 110px; } th.col-lion { min-width: 60px; } th.col-teague { min-width: 80px; } th.col-wildcat { min-width: 80px; } th.col-dhc { min-width: 60px; }
        th:not(:first-child), td:not(:first-child) { border-left: 2px dashed #555; }
        td:first-child { text-align: left; font-weight: normal; padding-left: 5px; border-right: 2px solid #555; }
        tr { border-bottom: 2px dashed #aaa; }
        thead tr { border-bottom: 2px solid #333; }
        tbody tr:last-child { border-bottom: none; }
        input[type="checkbox"] { transform: scale(1.8); cursor: pointer; accent-color: #333; }
        .cat-name { font-size: 0.7em; display: block; margin-top: -2px; font-weight: normal; }
        .tape { position: absolute; background-color: rgba(210, 180, 140, 0.5); transform: rotate(-2deg); box-shadow: 0 1px 2px rgba(0,0,0,0.2); z-index: -1; }
        .tape-top-left { top: 5px; left: 10%; width: 100px; height: 30px; transform: rotate(-5deg); }
        .tape-top-right { top: 5px; right: 10%; width: 100px; height: 30px; transform: rotate(3deg); }
        .tape-bottom-left { bottom: 5px; left: 15%; width: 80px; height: 25px; transform: rotate(4deg); }
        @media (max-width: 600px) {
            body { padding-top: 10px; }
            .checklist-container { padding: 20px 15px; width: 95%; }
            h1 { font-size: 2em; } .subtitle { font-size: 0.9em; margin-right: 5px; margin-top: -10px; }
            th, td { padding: 8px 4px; font-size: 0.9em; } input[type="checkbox"] { transform: scale(1.5); }
            th.col-pampas-cat, th.col-lion, th.col-teague, th.col-wildcat, th.col-dhc { min-width: auto; }
            .tape { display: none; }
        }
    </style>
</head>
<body>
    <div class="tape tape-top-left"></div>
    <div class="tape tape-top-right"></div>
    <div class="tape tape-bottom-left"></div>

    <div class="checklist-container">
        <h1>Dry White Season</h1>
        <h1>Checklist</h1>
        <div class="subtitle">stay weeeett!</div>
        <hr class="title-line">

        <table>
            <thead>
                <tr>
                    <th><!-- Month --></th>
                    <th class="col-pampas-cat">Pampas <span class="cat-name">CAT</span></th>
                    <th class="col-lion">LION</th>
                    <th class="col-teague">Teague</th>
                    <th class="col-wildcat">Wildcat</th>
                    <th class="col-dhc">DHC</th>
                </tr>
            </thead>
            <tbody id="checklist-body">
                <tr><td colspan="6" style="text-align:center; padding: 20px;">Loading checklist...</td></tr>
            </tbody>
        </table>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        console.log("Checklist script started.");

        const firebaseConfig = {
            apiKey: "AIzaSyDWfJ62MashJn0pqHgh1tqm8r4CmHEOJY4",
            authDomain: "drywhiteseasonlist.firebaseapp.com",
            // VVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV
            // IMPORTANT: REPLACE "YOUR_DATABASE_URL_HERE" WITH YOUR ACTUAL DATABASE URL
            // You can find this in your Firebase project -> Realtime Database page.
            // It usually looks like: https://<your-project-id>-default-rtdb.firebaseio.com
            // VVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV
            databaseURL: "YOUR_DATABASE_URL_HERE", // <<< --- !!! REPLACE THIS LINE !!!
            projectId: "drywhiteseasonlist",
            storageBucket: "drywhiteseasonlist.firebasestorage.app", // This is for Firebase Storage, not critical for Realtime DB
            messagingSenderId: "199117422641",
            appId: "1:199117422641:web:a87b0b9143234ccb599510",
            measurementId: "G-3DRTH5SYKX" // This is for Google Analytics, not critical for Realtime DB
        };

        try {
            console.log("Attempting to initialize Firebase with config:", firebaseConfig);
            if (!firebaseConfig.apiKey || !firebaseConfig.databaseURL || firebaseConfig.databaseURL === "YOUR_DATABASE_URL_HERE") {
                let errorMessage = "Firebase config is missing apiKey or databaseURL. ";
                if (firebaseConfig.databaseURL === "YOUR_DATABASE_URL_HERE") {
                    errorMessage += "Please replace 'YOUR_DATABASE_URL_HERE' with your actual databaseURL.";
                }
                console.error(errorMessage);
                document.getElementById('checklist-body').innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 20px; color: red;">${errorMessage} Checklist will not load. Check console.</td></tr>`;
                throw new Error("Firebase config error - missing vital info"); // Stop script execution
            }

            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully.");

            const database = firebase.database();
            const checklistRef = database.ref('checklistState');
            console.log("Firebase database reference obtained for 'checklistState'.");

            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const categories = [
                { id: "pampas" }, { id: "lion" }, { id: "teague" }, { id: "wildcat" }, { id: "dhc" }
            ];

            const initialChecksFromImage = {
                "pampas-Jan": true, "pampas-Feb": true, "pampas-Mar": true, "pampas-Apr": true, "pampas-May": true,
                "lion-Jan": true, "lion-Feb": true, "lion-Mar": true, "lion-Apr": true, "lion-May": true,
                "teague-Jan": true, "teague-Feb": true, "teague-Mar": true, "teague-Apr": true,
                "wildcat-Jan": true, "wildcat-Mar": true, "wildcat-Apr": true, "wildcat-May": true,
                "dhc-Jan": true, "dhc-Mar": true, "dhc-Apr": true
            };

            const tableBody = document.getElementById('checklist-body');

            function renderTable(currentChecklistState) {
                console.log("renderTable called with state:", currentChecklistState);
                tableBody.innerHTML = ''; // Clear "Loading..." or previous state

                if (!currentChecklistState || Object.keys(currentChecklistState).length === 0) {
                    console.warn("renderTable called with empty or invalid state. Rendering all unchecked for safety, but check Firebase data.");
                    // If state is truly empty after initial load, something might be wrong.
                    // For now, we'll render an empty table to avoid errors, but ideally, initial population should handle this.
                    currentChecklistState = {}; // Ensure it's an object to prevent errors below
                }

                months.forEach((month) => {
                    const row = tableBody.insertRow();
                    const monthCell = row.insertCell();
                    monthCell.textContent = month;

                    categories.forEach(category => {
                        const cell = row.insertCell();
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        const checkboxId = `${category.id}-${month}`;
                        checkbox.id = checkboxId;
                        checkbox.checked = currentChecklistState[checkboxId] || false;
                        checkbox.addEventListener('change', (event) => {
                            handleCheckboxChange(event.target.id, event.target.checked);
                        });
                        cell.appendChild(checkbox);
                    });
                });
                console.log("Table rendered.");
            }

            function handleCheckboxChange(checkboxId, isChecked) {
                console.log(`Checkbox ${checkboxId} changed to ${isChecked}. Updating Firebase.`);
                const updates = {};
                updates[checkboxId] = isChecked;
                checklistRef.update(updates)
                    .catch(error => console.error("Error updating Firebase for " + checkboxId + ":", error));
            }

            console.log("Setting up Firebase on.value listener...");
            checklistRef.on('value', (snapshot) => {
                const dataFromFirebase = snapshot.val();
                console.log("Firebase on.value event. Data:", dataFromFirebase);

                if (dataFromFirebase === null) {
                    console.log("Firebase 'checklistState' is empty. Populating with initial data from image...");
                    const fullInitialStateToSave = {};
                    months.forEach(month => {
                        categories.forEach(category => {
                            const id = `${category.id}-${month}`;
                            fullInitialStateToSave[id] = initialChecksFromImage[id] || false;
                        });
                    });

                    console.log("Attempting to set initial data to Firebase:", fullInitialStateToSave);
                    checklistRef.set(fullInitialStateToSave)
                        .then(() => {
                            console.log("Initial data successfully populated to Firebase. Listener should re-trigger with this new data.");
                            // The 'on.value' listener will be automatically called again by Firebase
                            // once this 'set' operation completes and the data is available.
                            // So, no need to call renderTable() directly here.
                        })
                        .catch(error => {
                            console.error("Error populating initial data to Firebase:", error);
                            tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px; color: red;">Error populating initial data. Check console.</td></tr>';
                        });
                } else {
                    console.log("Data exists in Firebase. Rendering table.");
                    renderTable(dataFromFirebase);
                }
            }, (errorObject) => { // Changed 'error' to 'errorObject' to avoid conflict
                console.error("Firebase data fetching/listening error:", errorObject);
                console.error("Error code:", errorObject.code);
                console.error("Error message:", errorObject.message);
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 20px; color: red;">Could not connect to checklist database: ${errorObject.message}. See console.</td></tr>`;
            });

        } catch (e) {
            console.error("A critical error occurred in the script:", e);
            document.getElementById('checklist-body').innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px; color: red;">A critical script error occurred. Check console.</td></tr>';
        }
        console.log("Checklist script finished initial setup process.");
    </script>
</body>
</html>