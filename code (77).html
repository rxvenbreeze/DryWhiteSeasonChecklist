<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dry White Season Checklist (Shared)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Permanent Marker', cursive;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding-top: 20px;
            padding-bottom: 40px;
            color: #333;
        }
        #checklist-wrapper {
            display: none;
        }
        .checklist-container {
            background-color: white;
            padding: 30px 40px;
            border-radius: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 800px; /* Slightly increased max-width for the new column */
        }
        h1 {
            font-size: 2.8em; text-align: center; margin-top: 0; margin-bottom: 5px; color: #222; line-height: 1;
        }
        .subtitle {
            text-align: right; font-size: 1.1em; margin-top: -15px; margin-bottom: 10px; margin-right: 20px; color: #444; font-style: italic;
        }
        hr.title-line {
            border: 0; height: 2px; background-color: #333; margin-bottom: 20px;
        }
        table {
            width: 100%; border-collapse: collapse; margin-top: 10px;
        }
        th, td {
            padding: 12px 8px; text-align: center; font-size: 1.1em; vertical-align: middle;
        }
        /* Adjusted min-widths slightly, added Snow Leopard */
        th.col-pampas-cat { min-width: 100px; }
        th.col-lion { min-width: 50px; }
        th.col-teague { min-width: 70px; }
        th.col-wildcat { min-width: 70px; }
        th.col-dhc { min-width: 50px; }
        th.col-snow-leopard { min-width: 120px; } /* New column for Snow Leopard */

        th:not(:first-child), td:not(:first-child) { border-left: 2px dashed #555; }
        td:first-child { text-align: left; font-weight: normal; padding-left: 5px; border-right: 2px solid #555; }
        tr { border-bottom: 2px dashed #aaa; }
        thead tr { border-bottom: 2px solid #333; }
        tbody tr:last-child { border-bottom: none; }
        input[type="checkbox"] { transform: scale(1.8); cursor: pointer; accent-color: #333; }
        .cat-name { font-size: 0.7em; display: block; margin-top: -2px; font-weight: normal; }
        .tape { position: absolute; background-color: rgba(210, 180, 140, 0.5); transform: rotate(-2deg); box-shadow: 0 1px 2px rgba(0,0,0,0.2); z-index: -1; }
        .tape-top-left { top: 5px; left: 10%; width: 100px; height: 30px; transform: rotate(-5deg); }
        .tape-top-right { top: 5px; right: 10%; width: 100px; height: 30px; transform: rotate(3deg); }
        .tape-bottom-left { bottom: 5px; left: 15%; width: 80px; height: 25px; transform: rotate(4deg); }

        #password-prompt {
            text-align: center; padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        #password-prompt input[type="password"] {
            padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; font-size: 1em;
        }
        #password-prompt button {
            padding: 10px 20px; background-color: #5cb85c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; font-family: 'Permanent Marker', cursive;
        }
        #password-prompt button:hover { background-color: #4cae4c; }

        @media (max-width: 700px) { /* Adjusted breakpoint slightly */
            .checklist-container { padding: 20px 10px; width: 98%; max-width: none;} /* Allow full width on smaller */
            h1 { font-size: 2em; } .subtitle { font-size: 0.9em; margin-right: 5px; margin-top: -10px; }
            th, td { padding: 8px 3px; font-size: 0.8em; } /* Smaller padding/font for more columns */
            input[type="checkbox"] { transform: scale(1.4); }
            th.col-pampas-cat, th.col-lion, th.col-teague, th.col-wildcat, th.col-dhc, th.col-snow-leopard { min-width: auto; }
            .tape { display: none; }
            .cat-name { font-size: 0.6em;}
        }
    </style>
</head>
<body>

    <div id="password-prompt">
        <h2>Enter Password</h2>
        <input type="password" id="password-input" placeholder="Password">
        <br>
        <button onclick="checkPassword()">Enter</button>
        <p id="password-error" style="color: red; display: none;">Incorrect password.</p>
    </div>

    <div id="checklist-wrapper">
        <div class="tape tape-top-left"></div>
        <div class="tape tape-top-right"></div>
        <div class="tape tape-bottom-left"></div>

        <div class="checklist-container">
            <h1>Dry White Season</h1>
            <h1>Checklist</h1>
            <div class="subtitle">stay weeeett!</div>
            <hr class="title-line">

            <table>
                <thead>
                    <tr>
                        <th><!-- Month --></th>
                        <th class="col-pampas-cat">Pampas <span class="cat-name">CAT</span></th>
                        <th class="col-lion">LION</th>
                        <th class="col-teague">Teague</th>
                        <th class="col-wildcat">Wildcat</th>
                        <th class="col-dhc">DHC</th>
                        <th class="col-snow-leopard">Snow Leopard</th> <!-- NEW HEADER -->
                    </tr>
                </thead>
                <tbody id="checklist-body">
                    <!-- Initial loading message, colspan updated -->
                    <tr><td colspan="7" style="text-align:center; padding: 20px;">Loading checklist...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const CORRECT_PASSWORD = "pride4life";

        function checkPassword() {
            const enteredPassword = document.getElementById('password-input').value;
            const errorMsg = document.getElementById('password-error');
            if (enteredPassword === CORRECT_PASSWORD) {
                document.getElementById('password-prompt').style.display = 'none';
                document.getElementById('checklist-wrapper').style.display = 'block';
                document.body.style.backgroundImage = `
                    linear-gradient(to right, rgba(0,0,0,0.1) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(0,0,0,0.1) 1px, transparent 1px)`;
                document.body.style.backgroundSize = `20px 20px`;
                document.body.style.alignItems = 'flex-start';
                initializeChecklistApp();
            } else {
                errorMsg.style.display = 'block';
                document.getElementById('password-input').value = '';
            }
        }
        document.getElementById('password-input').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                checkPassword();
            }
        });

        function initializeChecklistApp() {
            console.log("Checklist script started AFTER password entry.");

            const firebaseConfig = {
                apiKey: "AIzaSyA40XaGlDrUyWBvqdllnw1ypY9D_sUERYQ",
                authDomain: "drywhiteseasonchecklist.firebaseapp.com",
                databaseURL: "https://drywhiteseasonlist-default-rtdb.firebaseio.com/",
                projectId: "drywhiteseasonchecklist",
                storageBucket: "drywhiteseasonchecklist.firebasestorage.app",
                messagingSenderId: "226124944736",
                appId: "1:226124944736:web:f1919aaf924612d3f37a05",
                measurementId: "G-H5LLZPW5CK"
            };

            try {
                console.log("Attempting to initialize Firebase with config:", firebaseConfig);
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    console.log("Firebase initialized successfully.");
                } else {
                    console.log("Firebase already initialized.");
                }

                const database = firebase.database();
                const checklistRef = database.ref('checklistState');
                console.log("Firebase database reference obtained for 'checklistState'.");

                const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                const categories = [ // UPDATED CATEGORIES
                    { id: "pampas" },
                    { id: "lion" },
                    { id: "teague" },
                    { id: "wildcat" },
                    { id: "dhc" },
                    { id: "snowleopard" } // New category ID (lowercase, no spaces for ID)
                ];

                // initialChecksFromImage does NOT need to include snowleopard explicitly here.
                // The logic in the 'on.value' event when dataFromFirebase is null
                // will ensure that all categories (including snowleopard) get an entry,
                // defaulting to 'false' if not in initialChecksFromImage.
                const initialChecksFromImage = {
                    "pampas-Jan": true, "pampas-Feb": true, "pampas-Mar": true, "pampas-Apr": true, "pampas-May": true,
                    "lion-Jan": true, "lion-Feb": true, "lion-Mar": true, "lion-Apr": true, "lion-May": true,
                    "teague-Jan": true, "teague-Feb": true, "teague-Mar": true, "teague-Apr": true,
                    "wildcat-Jan": true, "wildcat-Mar": true, "wildcat-Apr": true, "wildcat-May": true,
                    "dhc-Jan": true, "dhc-Mar": true, "dhc-Apr": true
                    // No "snowleopard" entries needed here; they will default to false on initial population.
                };

                const tableBody = document.getElementById('checklist-body');

                function renderTable(currentChecklistState) {
                    console.log("renderTable called with state:", currentChecklistState);
                    tableBody.innerHTML = '';

                    if (!currentChecklistState || Object.keys(currentChecklistState).length === 0) {
                        console.warn("renderTable called with empty or invalid state. Rendering all unchecked.");
                        currentChecklistState = {};
                    }

                    months.forEach((month) => {
                        const row = tableBody.insertRow();
                        const monthCell = row.insertCell();
                        monthCell.textContent = month;

                        categories.forEach(category => { // This loop now includes snowleopard
                            const cell = row.insertCell();
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            const checkboxId = `${category.id}-${month}`; // e.g., snowleopard-Jan
                            checkbox.id = checkboxId;
                            checkbox.checked = currentChecklistState[checkboxId] || false;
                            checkbox.addEventListener('change', (event) => {
                                handleCheckboxChange(event.target.id, event.target.checked);
                            });
                            cell.appendChild(checkbox);
                        });
                    });
                    console.log("Table rendered.");
                }

                function handleCheckboxChange(checkboxId, isChecked) {
                    console.log(`Checkbox ${checkboxId} changed to ${isChecked}. Updating Firebase.`);
                    const updates = {};
                    updates[checkboxId] = isChecked;
                    checklistRef.update(updates)
                        .catch(error => console.error("Error updating Firebase for " + checkboxId + ":", error));
                }

                console.log("Setting up Firebase on.value listener...");
                checklistRef.on('value', (snapshot) => {
                    const dataFromFirebase = snapshot.val();
                    console.log("Firebase on.value event. Data:", dataFromFirebase);

                    if (dataFromFirebase === null) {
                        console.log("Firebase 'checklistState' is empty. Populating with initial data from image (and defaults for new categories)...");
                        const fullInitialStateToSave = {};
                        months.forEach(month => {
                            categories.forEach(category => { // This loop now includes snowleopard
                                const id = `${category.id}-${month}`;
                                // Use value from initialChecksFromImage if present, otherwise default to false
                                fullInitialStateToSave[id] = initialChecksFromImage[id] || false;
                            });
                        });

                        console.log("Attempting to set initial data to Firebase:", fullInitialStateToSave);
                        checklistRef.set(fullInitialStateToSave)
                            .then(() => {
                                console.log("Initial data successfully populated to Firebase. Listener should re-trigger.");
                            })
                            .catch(error => {
                                console.error("Error populating initial data to Firebase:", error);
                                tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color: red;">Error populating initial data. Check console.</td></tr>';
                            });
                    } else {
                        console.log("Data exists in Firebase. Rendering table.");
                        renderTable(dataFromFirebase);
                    }
                }, (errorObject) => {
                    console.error("Firebase data fetching/listening error:", errorObject);
                    if (errorObject.code) console.error("Firebase Error Code:", errorObject.code);
                    if (errorObject.message) console.error("Firebase Error Message:", errorObject.message);
                    // Updated colspan for error message
                    tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 20px; color: red;">Could not connect to checklist database: ${errorObject.message || 'Unknown error'}. See console.</td></tr>`;
                });

            } catch (e) {
                console.error("A critical error occurred in the checklist app script:", e);
                if(e.stack) console.error(e.stack);
                // Updated colspan for error message
                document.getElementById('checklist-body').innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color: red;">A critical script error occurred initializing the checklist. Check console.</td></tr>';
            }
            console.log("Checklist app finished initial setup process.");
        }
    </script>
</body>
</html>